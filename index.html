<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìš´ì˜_ì ì‹¬íˆ¬í‘œ (GitHub Pages)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --active:#F2F2F2;   /* ì§„í–‰ ê°€ëŠ¥(ì—°í•œ íšŒìƒ‰) */
      --idle:#FFFFFF;     /* ëŒ€ê¸°(í°ìƒ‰) */
      --locked:#E0E0E0;   /* ë§ˆê°/ì ê¸ˆ(ì§„í•œ íšŒìƒ‰) */
      --winner:#E6F4EA;   /* 1ìœ„ ê°•ì¡° */
    }
    body { background:#fafafa; }
    .phase-box { border-radius:16px; }
    .cell-active { background: var(--active) !important; }
    .cell-idle { background: var(--idle) !important; }
    .cell-locked { background: var(--locked) !important; }
    .winner { background: var(--winner) !important; font-weight:700; }
    .table thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .small-muted { font-size:.9rem; color:#6c757d; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .nowrap { white-space: nowrap; }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <div>
        <h1 class="h4 mb-1">ìš´ì˜_ì ì‹¬íˆ¬í‘œ (GitHub Pages)</h1>
        <div class="small-muted">
          ì‹œê°„ ê¸°ì¤€: <span class="mono">Asia/Seoul</span> Â· íˆ¬í‘œ(10:00~11:00) Â· ë©”ë‰´í‘œì‹œ(11:00~11:20, ì…ë ¥ì œí•œ ì—†ìŒ)
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button id="btnReset" class="btn btn-outline-danger btn-sm">ì˜¤ëŠ˜ ë¦¬ì…‹(ë¡œì»¬)</button>
        <button id="btnCopy" class="btn btn-outline-secondary btn-sm">ê²°ê³¼ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-lg-7">
        <div class="p-3 bg-white shadow-sm phase-box">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="fw-semibold">í˜„ì¬ ìƒíƒœ</div>
              <div id="phaseText" class="mono"></div>
            </div>
            <div class="text-end">
              <div class="fw-semibold">ì˜¤ëŠ˜</div>
              <div id="todayText" class="mono"></div>
            </div>
          </div>
          <hr class="my-3">
          <div class="small-muted">
            ê·œì¹™:
            <ul class="mb-0">
              <li>ì‹ì‚¬X ì²´í¬ ì‹œ: ê°™ì€ í–‰ ì‹ë‹¹ íˆ¬í‘œ ëª¨ë‘ í•´ì œ + ë©”ë‰´(H~J) ì…ë ¥ ì°¨ë‹¨(í† ìŠ¤íŠ¸)</li>
              <li>ì‹ë‹¹ ì²´í¬ ì‹œ: ì‹ì‚¬X ìë™ í•´ì œ</li>
              <li>1ì¸ë‹¹ ì‹ë‹¹ ì„ íƒ ìµœëŒ€ 3ê°œ (ì‹ì‚¬X ì œì™¸)</li>
              <li>11:00 ì´í›„ íˆ¬í‘œ(B~G) ìˆ˜ì • ë¶ˆê°€(í”„ë¡ íŠ¸ì—ì„œ ì°¨ë‹¨)</li>
              <li>ë©”ë‰´(H~J)ëŠ” ì‹œê°„ì— ë”°ë¥¸ ì…ë ¥ ì œí•œ ì—†ìŒ(ë‹¨, ì‹ì‚¬XëŠ” í•­ìƒ ì°¨ë‹¨)</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="p-3 bg-white shadow-sm phase-box">
          <div class="fw-semibold mb-2">Slack (ì„ íƒ)</div>
          <div class="small-muted mb-2">
            âš ï¸ GitHub Pagesì— ì›¹í›… URLì„ ë„£ìœ¼ë©´ ë…¸ì¶œë¨. ìš´ì˜ìš©ì´ë©´ í”„ë¡ì‹œ(Cloudflare Worker ë“±) ì¶”ì²œ.
          </div>
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">Webhook</span>
            <input id="slackWebhook" class="form-control mono" placeholder="https://hooks.slack.com/services/..." />
            <button id="btnSaveWebhook" class="btn btn-outline-primary">ì €ì¥</button>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <button id="btnSlackVote" class="btn btn-primary btn-sm">íˆ¬í‘œ ê²°ê³¼ ë³´ë‚´ê¸°(11:00 í¬ë§·)</button>
            <button id="btnSlackMenu" class="btn btn-success btn-sm">ë©”ë‰´ ê²°ê³¼ ë³´ë‚´ê¸°(11:20 í¬ë§·)</button>
          </div>
        </div>
      </div>
    </div>

    <div class="p-3 bg-white shadow-sm phase-box mb-3">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
        <div class="fw-semibold">ì°¸ì—¬ì</div>
        <div class="d-flex flex-wrap gap-2">
          <button id="btnAddPerson" class="btn btn-outline-primary btn-sm">+ ì´ë¦„ ì¶”ê°€</button>
          <button id="btnExport" class="btn btn-outline-secondary btn-sm">JSON ë‚´ë³´ë‚´ê¸°</button>
          <label class="btn btn-outline-secondary btn-sm mb-0">
            JSON ê°€ì ¸ì˜¤ê¸° <input id="fileImport" type="file" accept="application/json" hidden>
          </label>
        </div>
      </div>
      <div class="small-muted mb-2">
        ê¸°ë³¸ ì €ì¥ì†Œ: <span class="mono">localStorage</span> (ë¸Œë¼ìš°ì €ì— ì €ì¥). íŒ€ ê³µìœ /ê¸°ë¡ì´ í•„ìš”í•˜ë©´ ë°±ì—”ë“œ(ì˜ˆ: Apps Script WebApp) ë¶™ì—¬ì•¼ í•¨.
      </div>
    </div>

    <div class="table-responsive shadow-sm bg-white phase-box">
      <table id="voteTable" class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th class="nowrap">ì´ë¦„</th>
            <th class="text-center nowrap">ëŒ€ìˆ˜ì‹ë‹¹</th>
            <th class="text-center nowrap">160ë„</th>
            <th class="text-center nowrap">í•œì˜¥ì§‘ê¹€ì¹˜ì°œ</th>
            <th class="text-center nowrap">ì²œê¶</th>
            <th class="text-center nowrap">ë‘ë¦¬ìˆœëŒ€êµ­</th>
            <th class="text-center nowrap">ì‹ì‚¬X</th>
            <th class="nowrap">ë©”ë‰´ëª…</th>
            <th class="nowrap">ê°€ê²©</th>
            <th class="nowrap">ë¹„ê³ </th>
            <th class="text-center nowrap">ì‚­ì œ</th>
          </tr>

          <!-- ë“í‘œìˆ˜ -->
          <tr id="rowCounts">
            <th class="small-muted nowrap">ë“í‘œìˆ˜</th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono">-</th>
            <th colspan="4" class="small-muted">ì‹ì‚¬XëŠ” ì§‘ê³„ ì œì™¸</th>
          </tr>

          <!-- ë“±ìˆ˜ -->
          <tr id="rowRanks">
            <th class="small-muted nowrap">ë“±ìˆ˜</th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono"></th>
            <th class="text-center mono">-</th>
            <th colspan="4" class="small-muted">ë™ì ì€ ê³µë™ 1ìœ„</th>
          </tr>
        </thead>

        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-3 small-muted">
      íŒ: íœ´ì¼ ì œì™¸(êµ­ì •ê³µíœ´ì¼) ê°™ì€ â€œì˜ì—…ì¼ ê²Œì´íŠ¸â€ê°€ ê¼­ í•„ìš”í•˜ë©´,
      Google Calendar API(ê³µê°œ íœ´ì¼ ìº˜ë¦°ë”) + API Keyê°€ í•„ìš”í•¨(ì •ì  í˜ì´ì§€ë¼ í‚¤ ë…¸ì¶œ ì´ìŠˆ ìˆìŒ) â†’ ì„œë²„/í”„ë¡ì‹œ ê¶Œì¥.
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">ì•Œë¦¼</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /***********************
     * Config (ê³ ì •)
     ************************/
    const FIXED_RESTAURANTS = ['ëŒ€ìˆ˜ì‹ë‹¹','160ë„','í•œì˜¥ì§‘ê¹€ì¹˜ì°œ','ì²œê¶','ë‘ë¦¬ìˆœëŒ€êµ­'];
    const MAX_VOTE_PER_PERSON = 3;
    const OPT_OUT_LABEL = 'ì‹ì‚¬X';

    // Phases (Asia/Seoul ê¸°ì¤€ìœ¼ë¡œ "ì‹œ:ë¶„"ë§Œ ì ìš©)
    const VOTE_START = { h:10, m:0 };
    const VOTE_CUTOFF = { h:11, m:0 };
    const MENU_CUTOFF = { h:11, m:20 };

    // localStorage keys
    const LS_KEY = 'oper_lunch_vote_state_v1';
    const LS_WEBHOOK = 'oper_lunch_vote_slack_webhook';

    /***********************
     * State
     ************************/
    function defaultState() {
      return {
        dateKey: ymdKST(new Date()), // ì˜¤ëŠ˜ ê¸°ì¤€ í‚¤
        people: [
          // ì˜ˆì‹œ(ì›í•˜ë©´ ì§€ìš°ê¸°)
          // { name:'í™ê¸¸ë™', votes:[false,false,false,false,false], optOut:false, menu:'', price:'', note:'' }
        ],
        // ê°„ë‹¨ ì¤‘ë³µ ë°©ì§€: ê°™ì€ ë‚ ì§œì— Slack ë²„íŠ¼ ì—¬ëŸ¬ ë²ˆ ëˆ„ë¥¼ê¹Œë´
        slackSent: { vote:false, menu:false }
      };
    }

    function loadState() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return defaultState();
      try {
        const st = JSON.parse(raw);
        // ë‚ ì§œê°€ ë°”ë€Œë©´ ìë™ ë¦¬ì…‹(ë¡œì»¬)
        const today = ymdKST(new Date());
        if (st.dateKey !== today) return defaultState();
        // ìµœì†Œ ë³´ì •
        st.people = Array.isArray(st.people) ? st.people : [];
        st.slackSent = st.slackSent || { vote:false, menu:false };
        return st;
      } catch {
        return defaultState();
      }
    }

    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      recomputeSummaryAndRenderHead();
    }

    let state = loadState();

    /***********************
     * Time helpers (KST)
     ************************/
    function nowKST() {
      // ë¸Œë¼ìš°ì € ë¡œì»¬ íƒ€ì„ì¡´ì´ ë‹¬ë¼ë„ KST ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•˜ê¸° ìœ„í•´ UTC+9 ê°•ì œ
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 9 * 3600000);
    }

    function ymdKST(d) {
      const k = (d instanceof Date) ? d : new Date(d);
      const kk = (k.getTime() + (k.getTimezoneOffset()*60000) + 9*3600000);
      const kst = new Date(kk);
      const y = kst.getFullYear();
      const m = String(kst.getMonth()+1).padStart(2,'0');
      const da = String(kst.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function atKSTToday(h, m) {
      const k = nowKST();
      return new Date(k.getFullYear(), k.getMonth(), k.getDate(), h, m, 0, 0);
    }

    function phaseNow() {
      const k = nowKST();
      const voteStart = atKSTToday(VOTE_START.h, VOTE_START.m);
      const voteCutoff = atKSTToday(VOTE_CUTOFF.h, VOTE_CUTOFF.m);
      const menuCutoff = atKSTToday(MENU_CUTOFF.h, MENU_CUTOFF.m);

      if (k < voteStart) return 'BEFORE_START';
      if (k < voteCutoff) return 'VOTE_ACTIVE';
      if (k < menuCutoff) return 'MENU_ACTIVE';
      return 'ALL_LOCKED';
    }

    function isAfterVoteCutoff() {
      return nowKST().getTime() >= atKSTToday(VOTE_CUTOFF.h, VOTE_CUTOFF.m).getTime();
    }

    /***********************
     * UI helpers
     ************************/
    const toastEl = document.getElementById('toast');
    const toast = new bootstrap.Toast(toastEl, { delay: 2500 });

    function showToast(title, body) {
      document.getElementById('toastTitle').textContent = title || 'ì•Œë¦¼';
      document.getElementById('toastBody').textContent = body || '';
      toast.show();
    }

    function fmtWon(x) {
      const n = Number(String(x).replaceAll(',',''));
      if (!Number.isFinite(n)) return '';
      return n.toLocaleString('ko-KR');
    }

    /***********************
     * Render
     ************************/
    const tbody = document.getElementById('tbody');

    function rowTemplate(p, idx) {
      const tr = document.createElement('tr');
      tr.dataset.idx = String(idx);

      // Name
      const tdName = document.createElement('td');
      tdName.className = 'nowrap';
      const nameInput = document.createElement('input');
      nameInput.className = 'form-control form-control-sm';
      nameInput.value = p.name || '';
      nameInput.placeholder = 'ì´ë¦„';
      nameInput.addEventListener('change', () => {
        state.people[idx].name = nameInput.value.trim();
        saveState();
      });
      tdName.appendChild(nameInput);
      tr.appendChild(tdName);

      // Votes (B~F)
      for (let i=0;i<FIXED_RESTAURANTS.length;i++) {
        const td = document.createElement('td');
        td.className = 'text-center';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'form-check-input';
        cb.checked = !!(p.votes && p.votes[i]);

        cb.addEventListener('change', () => {
          // 11:00 ì´í›„ íˆ¬í‘œ ìˆ˜ì • ë¶ˆê°€
          if (isAfterVoteCutoff()) {
            cb.checked = !!(state.people[idx].votes[i]);
            showToast('ë§ˆê°(íˆ¬í‘œ)', '11:00 ì´í›„ì—ëŠ” íˆ¬í‘œ/ì‹ì‚¬X ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.');
            return;
          }

          // ì‹ë‹¹ ì²´í¬ ì‹œ ì‹ì‚¬X ìë™ í•´ì œ
          if (cb.checked) state.people[idx].optOut = false;

          // Max 3 ì²´í¬
          const nextVotes = [...(state.people[idx].votes || [false,false,false,false,false])];
          nextVotes[i] = cb.checked;
          const trueCount = nextVotes.filter(v => v === true).length;
          if (cb.checked && trueCount > MAX_VOTE_PER_PERSON) {
            cb.checked = false;
            showToast('ì œí•œ', `ì‹ë‹¹ì€ 1ì¸ë‹¹ ìµœëŒ€ ${MAX_VOTE_PER_PERSON}ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            return;
          }

          state.people[idx].votes = nextVotes;
          saveState();
          render(); // optOut ì»¬ëŸ¼/ìƒ‰ìƒ ì˜í–¥
        });

        td.appendChild(cb);
        tr.appendChild(td);
      }

      // Opt-out (G)
      const tdOpt = document.createElement('td');
      tdOpt.className = 'text-center';
      const cbOpt = document.createElement('input');
      cbOpt.type = 'checkbox';
      cbOpt.className = 'form-check-input';
      cbOpt.checked = !!p.optOut;

      cbOpt.addEventListener('change', () => {
        if (isAfterVoteCutoff()) {
          cbOpt.checked = !!state.people[idx].optOut;
          showToast('ë§ˆê°(íˆ¬í‘œ)', '11:00 ì´í›„ì—ëŠ” íˆ¬í‘œ/ì‹ì‚¬X ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.');
          return;
        }

        if (cbOpt.checked) {
          // ì‹ì‚¬X true -> ì‹ë‹¹ í•´ì œ + ë©”ë‰´ í´ë¦¬ì–´
          state.people[idx].votes = [false,false,false,false,false];
          state.people[idx].optOut = true;
          state.people[idx].menu = '';
          state.people[idx].price = '';
          state.people[idx].note = '';
          saveState();
          render();
          showToast('ì‹ì‚¬X', 'ì‹ë‹¹ íˆ¬í‘œê°€ í•´ì œë˜ê³  ë©”ë‰´ ì…ë ¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.');
          return;
        } else {
          state.people[idx].optOut = false;
          saveState();
          render();
        }
      });

      tdOpt.appendChild(cbOpt);
      tr.appendChild(tdOpt);

      // Menu (H)
      const tdMenu = document.createElement('td');
      const menuInput = document.createElement('input');
      menuInput.className = 'form-control form-control-sm';
      menuInput.value = p.menu || '';
      menuInput.placeholder = 'ë©”ë‰´ëª…';
      menuInput.addEventListener('input', () => {
        if (state.people[idx].optOut) {
          menuInput.value = state.people[idx].menu || '';
          showToast('ì°¨ë‹¨(ì‹ì‚¬X)', 'ì‹ì‚¬X ì„ íƒìëŠ” ë©”ë‰´ ì…ë ¥ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        state.people[idx].menu = menuInput.value;
        saveState();
      });
      tdMenu.appendChild(menuInput);
      tr.appendChild(tdMenu);

      // Price (I)
      const tdPrice = document.createElement('td');
      const priceInput = document.createElement('input');
      priceInput.className = 'form-control form-control-sm text-end';
      priceInput.inputMode = 'numeric';
      priceInput.placeholder = '0';
      priceInput.value = (p.price ?? '') === '' ? '' : fmtWon(p.price);
      priceInput.addEventListener('blur', () => {
        if (state.people[idx].optOut) {
          priceInput.value = (state.people[idx].price ?? '') === '' ? '' : fmtWon(state.people[idx].price);
          showToast('ì°¨ë‹¨(ì‹ì‚¬X)', 'ì‹ì‚¬X ì„ íƒìëŠ” ë©”ë‰´ ì…ë ¥ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        const raw = String(priceInput.value || '').replaceAll(',','').trim();
        if (raw === '') {
          state.people[idx].price = '';
          saveState();
          return;
        }
        const n = Number(raw);
        if (!Number.isFinite(n) || n < 0) {
          priceInput.value = (state.people[idx].price ?? '') === '' ? '' : fmtWon(state.people[idx].price);
          showToast('ì…ë ¥ ì˜¤ë¥˜', 'ê°€ê²©ì€ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        state.people[idx].price = n;
        priceInput.value = fmtWon(n);
        saveState();
      });
      tdPrice.appendChild(priceInput);
      tr.appendChild(tdPrice);

      // Note (J)
      const tdNote = document.createElement('td');
      const noteInput = document.createElement('input');
      noteInput.className = 'form-control form-control-sm';
      noteInput.value = p.note || '';
      noteInput.placeholder = 'ë¹„ê³ ';
      noteInput.addEventListener('input', () => {
        if (state.people[idx].optOut) {
          noteInput.value = state.people[idx].note || '';
          showToast('ì°¨ë‹¨(ì‹ì‚¬X)', 'ì‹ì‚¬X ì„ íƒìëŠ” ë©”ë‰´ ì…ë ¥ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        state.people[idx].note = noteInput.value;
        saveState();
      });
      tdNote.appendChild(noteInput);
      tr.appendChild(tdNote);

      // Delete
      const tdDel = document.createElement('td');
      tdDel.className = 'text-center';
      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-outline-danger btn-sm';
      btnDel.textContent = 'ì‚­ì œ';
      btnDel.addEventListener('click', () => {
        state.people.splice(idx, 1);
        saveState();
        render();
      });
      tdDel.appendChild(btnDel);
      tr.appendChild(tdDel);

      return tr;
    }

    function applyPhaseColorsToCells() {
      const ph = phaseNow();
      const rows = [...tbody.querySelectorAll('tr')];

      for (const tr of rows) {
        // td indices:
        // 0 name, 1~5 votes, 6 optOut, 7 menu, 8 price, 9 note, 10 del
        const tds = tr.querySelectorAll('td');

        const voteTds = [tds[1],tds[2],tds[3],tds[4],tds[5],tds[6]];
        const menuTds = [tds[7],tds[8],tds[9]];

        voteTds.forEach(td => td.classList.remove('cell-active','cell-idle','cell-locked'));
        menuTds.forEach(td => td.classList.remove('cell-active','cell-idle','cell-locked'));

        if (ph === 'VOTE_ACTIVE') {
          voteTds.forEach(td => td.classList.add('cell-active'));
          menuTds.forEach(td => td.classList.add('cell-idle'));
        } else if (ph === 'MENU_ACTIVE') {
          voteTds.forEach(td => td.classList.add('cell-locked'));
          menuTds.forEach(td => td.classList.add('cell-active'));
        } else if (ph === 'ALL_LOCKED') {
          voteTds.forEach(td => td.classList.add('cell-locked'));
          menuTds.forEach(td => td.classList.add('cell-locked')); // í‘œì‹œë§Œ ì¢…ë£Œ ëŠë‚Œ
        } else {
          voteTds.forEach(td => td.classList.add('cell-idle'));
          menuTds.forEach(td => td.classList.add('cell-idle'));
        }
      }
    }

    function recomputeSummaryAndRenderHead() {
      // counts: ì‹ë‹¹ë§Œ(B~F), optOut ì œì™¸
      const counts = new Array(FIXED_RESTAURANTS.length).fill(0);
      for (const p of state.people) {
        const votes = p.votes || [false,false,false,false,false];
        for (let i=0;i<FIXED_RESTAURANTS.length;i++) if (votes[i] === true) counts[i]++;
      }

      // ranks (ë™ì  ê³µë™ 1ìœ„)
      const max = Math.max(...counts);
      const ranks = counts.map(c => {
        if (c === 0) return '';
        // RANK.EQ style: 1 + (# of values > c)
        const higher = counts.filter(x => x > c).length;
        return String(1 + higher);
      });

      // head rows
      const rowCounts = document.querySelectorAll('#rowCounts th');
      const rowRanks  = document.querySelectorAll('#rowRanks th');

      // rowCounts: th[0]=label, then 5 restaurant cells at th[1..5]
      for (let i=0;i<FIXED_RESTAURANTS.length;i++) rowCounts[i+1].textContent = String(counts[i]);

      // ranks
      for (let i=0;i<FIXED_RESTAURANTS.length;i++) rowRanks[i+1].textContent = String(ranks[i] || '');

      // winner highlight (header counts/ranks)
      // Reset
      for (let i=0;i<FIXED_RESTAURANTS.length;i++) {
        rowCounts[i+1].classList.remove('winner');
        rowRanks[i+1].classList.remove('winner');
        // also the top header row ths
        const topHeadTh = document.querySelector(`#voteTable thead tr:first-child th:nth-child(${2+i})`);
        if (topHeadTh) topHeadTh.classList.remove('winner');
      }
      if (max > 0) {
        for (let i=0;i<FIXED_RESTAURANTS.length;i++) {
          if (counts[i] === max) {
            rowCounts[i+1].classList.add('winner');
            rowRanks[i+1].classList.add('winner');
            const topHeadTh = document.querySelector(`#voteTable thead tr:first-child th:nth-child(${2+i})`);
            if (topHeadTh) topHeadTh.classList.add('winner');
          }
        }
      }
    }

    function render() {
      // date/phase text
      const k = nowKST();
      document.getElementById('todayText').textContent = `${ymdKST(new Date())}`;
      const ph = phaseNow();
      const phMap = {
        BEFORE_START:'BEFORE_START (10:00 ì „)',
        VOTE_ACTIVE:'VOTE_ACTIVE (10:00~11:00)',
        MENU_ACTIVE:'MENU_ACTIVE (11:00~11:20)',
        ALL_LOCKED:'ALL_LOCKED (11:20 ì´í›„)'
      };
      document.getElementById('phaseText').textContent =
        `${phMap[ph]} Â· KST ${String(k.getHours()).padStart(2,'0')}:${String(k.getMinutes()).padStart(2,'0')}`;

      // body
      tbody.innerHTML = '';
      state.people.forEach((p, idx) => tbody.appendChild(rowTemplate(p, idx)));

      recomputeSummaryAndRenderHead();
      applyPhaseColorsToCells();
    }

    /***********************
     * Export / Import
     ************************/
    function downloadJson(obj, filename) {
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('btnExport').addEventListener('click', () => {
      downloadJson(state, `oper_lunch_vote_${state.dateKey}.json`);
    });

    document.getElementById('fileImport').addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      try {
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if (!obj || !Array.isArray(obj.people)) throw new Error('invalid');
        // ë‚ ì§œëŠ” ì˜¤ëŠ˜ë¡œ ê°•ì œ
        obj.dateKey = ymdKST(new Date());
        obj.slackSent = { vote:false, menu:false };
        state = obj;
        saveState();
        render();
        showToast('ê°€ì ¸ì˜¤ê¸°', 'JSON ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
      } catch {
        showToast('ì˜¤ë¥˜', 'JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      } finally {
        e.target.value = '';
      }
    });

    /***********************
     * Buttons
     ************************/
    document.getElementById('btnAddPerson').addEventListener('click', () => {
      state.people.push({ name:'', votes:[false,false,false,false,false], optOut:false, menu:'', price:'', note:'' });
      saveState();
      render();
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if (!confirm('ì˜¤ëŠ˜ ë°ì´í„°(ë¡œì»¬)ë¥¼ ë¦¬ì…‹í• ê¹Œìš”?')) return;
      state = defaultState();
      saveState();
      render();
      showToast('ë¦¬ì…‹', 'ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    document.getElementById('btnCopy').addEventListener('click', async () => {
      const text = buildResultText();
      try {
        await navigator.clipboard.writeText(text);
        showToast('ë³µì‚¬', 'ê²°ê³¼ í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch {
        showToast('ì˜¤ë¥˜', 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });

    /***********************
     * Slack
     ************************/
    function loadWebhook() {
      const w = localStorage.getItem(LS_WEBHOOK) || '';
      document.getElementById('slackWebhook').value = w;
    }
    function saveWebhook() {
      const v = document.getElementById('slackWebhook').value.trim();
      localStorage.setItem(LS_WEBHOOK, v);
      showToast('Slack', v ? 'ì›¹í›… ì €ì¥ë¨' : 'ì›¹í›…ì´ ë¹„ì–´ìˆìŒ');
    }
    document.getElementById('btnSaveWebhook').addEventListener('click', saveWebhook);

    async function postSlack(text) {
      const url = (localStorage.getItem(LS_WEBHOOK) || '').trim();
      if (!url) {
        showToast('Slack', 'ì›¹í›… URLì´ ì—†ìŠµë‹ˆë‹¤.');
        return { ok:false };
      }
      try {
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'application/json; charset=utf-8' },
          body: JSON.stringify({ text })
        });
        return { ok: res.ok, status: res.status };
      } catch (e) {
        return { ok:false, error: String(e) };
      }
    }

    function kstDateText() {
      const k = nowKST();
      const y = k.getFullYear();
      const m = String(k.getMonth()+1).padStart(2,'0');
      const d = String(k.getDate()).padStart(2,'0');
      const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][k.getDay()];
      return `${y}-${m}-${d} (${dow})`;
    }

    function buildSlackVoteText() {
      const counts = new Array(FIXED_RESTAURANTS.length).fill(0);
      for (const p of state.people) {
        const votes = p.votes || [false,false,false,false,false];
        for (let i=0;i<FIXED_RESTAURANTS.length;i++) if (votes[i] === true) counts[i]++;
      }
      const max = Math.max(...counts);
      const winners = [];
      const lines = [];
      for (let i=0;i<FIXED_RESTAURANTS.length;i++) {
        lines.push(`- ${FIXED_RESTAURANTS[i]}: ${counts[i]}`);
        if (counts[i] === max && max > 0) winners.push(FIXED_RESTAURANTS[i]);
      }

      return (
        `ğŸ“Œ [íˆ¬í‘œ ê²°ê³¼] ì ì‹¬ ì‹ë‹¹\n` +
        `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
        `ğŸ—“ ${kstDateText()}\n\n` +
        `â° 11:00 ê¸°ì¤€\n` +
        `- ì‹ë‹¹íˆ¬í‘œ/ì‹ì‚¬X(B~G): íšŒìƒ‰(ì¢…ë£Œ)\n` +
        `- ë©”ë‰´ì·¨í•©(H~J): ì—°í•œ íšŒìƒ‰(í‘œì‹œ, 11:20ê¹Œì§€)\n` +
        `  â€» ë©”ë‰´ ì…ë ¥ ì œí•œì€ í•´ì œë¨\n\n` +
        `ğŸ† 1ìœ„: ${winners.length ? winners.join(', ') : '(ì—†ìŒ)'}${max > 0 ? ` (${max}í‘œ)` : ''}\n\n` +
        `ğŸ“Š ë“í‘œ í˜„í™©\n` +
        `${lines.join('\n')}\n`
      );
    }

    function buildSlackMenuText() {
      const lines = [];
      for (const p of state.people) {
        const name = String(p.name || '').trim();
        if (!name) continue;
        const menu = String(p.menu || '').trim();
        const note = String(p.note || '').trim();
        const hasPrice = !(p.price === '' || p.price === null || p.price === undefined);
        const hasMenuOrNote = !!menu || !!note;
        if (!hasMenuOrNote && !hasPrice) continue;

        const priceText = hasPrice ? ` (${Number(p.price).toLocaleString('ko-KR')}ì›)` : '';
        const noteText  = note ? ` Â· ${note}` : '';
        lines.push(`- ${name}: ${menu}${priceText}${noteText}`);
      }

      return (
        `ğŸ“Œ [ë©”ë‰´ ì·¨í•© ê²°ê³¼]\n` +
        `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n` +
        `ğŸ—“ ${kstDateText()}\n\n` +
        `â° 11:20 ê¸°ì¤€\n` +
        `- ë©”ë‰´ì·¨í•©(H~J): íšŒìƒ‰(ì¢…ë£Œ)\n` +
        `  â€» ì‹¤ì œ ì…ë ¥ ì œí•œì€ í•´ì œë¨(ê²°ê³¼ëŠ” í˜„ì¬ê°’ ê¸°ì¤€)\n\n` +
        `${lines.length ? `ğŸ½ ì˜¤ëŠ˜ ì£¼ë¬¸ ë‚´ì—­\n${lines.join('\n')}` : 'âš ï¸ ì…ë ¥ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.'}\n`
      );
    }

    document.getElementById('btnSlackVote').addEventListener('click', async () => {
      const text = buildSlackVoteText();
      const r = await postSlack(text);
      if (r.ok) showToast('Slack', 'íˆ¬í‘œ ê²°ê³¼ ì „ì†¡ ì™„ë£Œ');
      else showToast('Slack ì˜¤ë¥˜', `ì „ì†¡ ì‹¤íŒ¨ ${r.status || ''}`);
    });

    document.getElementById('btnSlackMenu').addEventListener('click', async () => {
      const text = buildSlackMenuText();
      const r = await postSlack(text);
      if (r.ok) showToast('Slack', 'ë©”ë‰´ ê²°ê³¼ ì „ì†¡ ì™„ë£Œ');
      else showToast('Slack ì˜¤ë¥˜', `ì „ì†¡ ì‹¤íŒ¨ ${r.status || ''}`);
    });

    /***********************
     * Result text (copy)
     ************************/
    function buildResultText() {
      const vote = buildSlackVoteText();
      const menu = buildSlackMenuText();
      return vote + '\n' + menu;
    }

    /***********************
     * Auto UI refresh
     ************************/
    function tick() {
      // ë‚ ì§œê°€ ë°”ë€Œë©´ ìë™ ë¦¬ì…‹(ë¡œì»¬)
      const today = ymdKST(new Date());
      if (state.dateKey !== today) {
        state = defaultState();
        saveState();
      }
      render();
    }

    /***********************
     * Init
     ************************/
    loadWebhook();
    render();
    // 15ì´ˆë§ˆë‹¤ ìƒíƒœ/ìƒ‰ìƒ ê°±ì‹ 
    setInterval(tick, 15000);
  </script>
</body>
</html>
